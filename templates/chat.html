<!DOCTYPE html>
<html lang="en">
<head>
    {{.MetaTags}}
    <style>
        html, body { 
            margin:0; 
            padding:0; 
            width:100%; 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        body { 
            display:flex; 
            flex-direction:column; 
            height: 100vh;
            height: var(--app-height, 100vh);
            overflow:hidden; 
            background-color: #fff; 
            color: #333;
            position: relative;
        }
        body::before {
            content: "ðŸ¥·";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 300px;
            opacity: 0.26;
            z-index: -1;
            pointer-events: none;
        }
        #header { 
            flex-shrink:0; 
            display:flex; 
            justify-content:flex-end; 
            align-items:center; 
            gap:8px; 
            background: #fff; 
            min-height: 40px;
            padding: 8px;
            padding-top: calc(8px + env(safe-area-inset-top, 0px));
            position: sticky;
            top: 0;
            border-bottom: 1px solid #e9ecef;
        }
        #messages { 
            display: flex;
            flex-direction: column-reverse;
            flex: 1; 
            overflow-y: auto; 
            padding: 0 12px; 
            font-size:16px; 
            line-height:1.5;
            gap: 8px;
            padding-top: calc(60px + 12px + 12px + env(safe-area-inset-top, 0px));
            padding-bottom: 84px;
        }
        #inputArea { 
            position: fixed; 
            bottom: 0;
            left: 0;
            right: 0;
            display:flex; 
            align-items:center; 
            gap:8px; 
            padding: 18px 20px 18px 16px; 
            padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px)); 
            border-top: 1px solid #e9ecef;
            background: #fff; 
            z-index: 10;
        }
        #msgInput { 
            flex:1; 
            min-width: 0;
            padding:10px 12px; 
            font-size:15px; 
            border-radius:12px; 
            border:1px solid #dee2e6; 
            -webkit-appearance:none; 
        }
        #sendBtn, #shareBtn { 
            padding:12px 14px; 
            font-size:15px; 
            border-radius:12px; 
            white-space:nowrap; 
            cursor:pointer; 
            flex-shrink:0; 
            border: 1px solid #000; 
            background-color: #000; 
            color: #fff; 
            transition: background-color 0.2s ease;
        }
        #sendBtn:hover, #shareBtn:hover { background-color: #333; }
        .msg { word-break:break-word; }
        .system-msg { word-break:break-word; color: #6c757d; font-style: italic; }
        #charCount { 
            font-size:14px; 
            user-select:none; 
            flex-shrink:0; 
            min-width:45px; 
            text-align:right; 
            color: #6c757d;
        }
        /* FIX: Add specific padding for the invite button */
        .invite-btn {
            padding: 8px 12px;
        }

        {{.ResponsiveCSS}}
        @media (max-width: 768px) {
            #inputArea { padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)); gap: 4px; }
            #messages { font-size: 18px; line-height: 1.6; }
            #msgInput { font-size: 16px; padding: 10px; }
            #sendBtn, #shareBtn { font-size: 14px; padding: 12px; }
            #charCount { font-size: 11px; min-width: 35px; }
            .invite-btn { padding: 6px 10px; }
        }
    </style>
</head>
<body>
<div id="header"><button id="shareBtn" class="invite-btn">invite</button></div>
<div id="messages"></div>

<div id="inputArea">
    <input id="msgInput" type="text" maxlength="160" placeholder="Say something..." autocomplete="off" enterkeyhint="send">
    <span id="charCount">0/160</span>
    <button id="sendBtn" type="button">Send</button>
</div>

<script>
    const setAppHeight = () => {
        const doc = document.documentElement;
        doc.style.setProperty('--app-height', `${window.innerHeight}px`);
    };
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    const elements = {
        messages: document.getElementById('messages'),
        input:    document.getElementById('msgInput'),
        charCount: document.getElementById('charCount'),
        sendBtn:    document.getElementById('sendBtn'),
        shareBtn: document.getElementById('shareBtn'),
    };

    const wsUrl = "{{.WSUrl}}";

    const MAX_RECONNECT_ATTEMPTS = 5;
    const INITIAL_RECONNECT_DELAY_MS = 2000;
    let reconnectAttempts = 0;
    let reconnectDelay = INITIAL_RECONNECT_DELAY_MS;
    let reconnectTimeout;
    let websocketConn;

    const connect = () => {
        clearTimeout(reconnectTimeout);
        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            elements.messages.innerHTML += '<div class="system-msg">Connection lost. Please refresh to reconnect.</div>';
            return;
        }
        
        websocketConn = new WebSocket(wsUrl);

        websocketConn.onopen = () => {
            console.log("WebSocket connection established.");
            reconnectAttempts = 0;
            reconnectDelay = INITIAL_RECONNECT_DELAY_MS;
        };

        websocketConn.onmessage = (event) => {
            const message = event.data;
            const isSystem = message.startsWith("System:");
            const messageEl = document.createElement('div');
            messageEl.className = isSystem ? 'system-msg' : 'msg';
            messageEl.textContent = message;
            
            elements.messages.prepend(messageEl);
            elements.messages.scrollTop = elements.messages.scrollHeight;
        };

        websocketConn.onclose = (event) => {
            console.log("WebSocket connection closed.", event);
            if (event.code !== 1000) {
                reconnectAttempts++;
                reconnectTimeout = setTimeout(connect, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 30000);
            }
        };

        websocketConn.onerror = (error) => { 
            console.error("WebSocket error:", error);
            reconnectAttempts++;
            reconnectTimeout = setTimeout(connect, reconnectDelay);
            reconnectDelay = Math.min(reconnectDelay * 2, 30000);
        };
    };

    const sendMessage = () => {
        const text = elements.input.value.trim();
        if (text && websocketConn && websocketConn.readyState === WebSocket.OPEN) {
            websocketConn.send(text);
            elements.input.value = '';
            updateCharCount();
        }
    };
    
    const shareLink = () => {
        const shareButton = document.getElementById('shareBtn');
        const originalText = shareButton.textContent;
        const textToCopy = location.href;
        const resetButtonText = () => { shareButton.textContent = originalText; };
        const copySuccess = () => {
            shareButton.textContent = 'Copied!';
            setTimeout(resetButtonText, 2000);
        };

        if (navigator.share) {
            navigator.share({ title: 'Join my Chat Room', text: 'Click the link to join my chat room!', url: textToCopy })
                .catch(() => fallbackCopy(textToCopy, copySuccess));
        } else {
            fallbackCopy(textToCopy, copySuccess);
        }
    };
    
    const fallbackCopy = (text, onSuccess) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) { onSuccess(); } else { console.error('Copy failed'); }
        } catch (err) { console.error('Copy error', err); }
        document.body.removeChild(textArea);
    };

    const updateCharCount = () => {
        elements.charCount.textContent = `${elements.input.value.length}/160`;
    };

    elements.sendBtn.addEventListener('click', sendMessage);
    elements.input.addEventListener('input', updateCharCount);
    elements.shareBtn.addEventListener('click', shareLink);

    elements.input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    connect();
    elements.input.focus();
    updateCharCount();
</script>
</body>
</html>