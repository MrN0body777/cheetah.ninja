<!DOCTYPE html>
<html lang="en">
<head>
    {{.MetaTags}}
    <style>
        html, body { 
            margin:0; 
            padding:0; 
            width:100%; 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "EmojiSymbols", emoji; 
        }
        body { 
            display:flex; 
            flex-direction:column; 
            height: 100%; 
            overflow:hidden; 
            background-color: #fff; 
            color: #333;
            position: relative;
        }
        body::before {
            content: "ðŸ¥·";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 300px;
            opacity: 0.26;
            z-index: -1;
            pointer-events: none;
        }
        #header { 
            flex-shrink:0; 
            display:flex; 
            justify-content:flex-end; 
            align-items:center; 
            gap:8px; 
            background: #fff; 
            padding: 12px 20px 12px 12px; 
            height: 60px; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            z-index: 12; 
            border-bottom: 1px solid #e9ecef;
        }
        #messages { 
            display: flex;
            flex-direction: column-reverse;
            flex: 1; 
            overflow-y: auto;
            padding: 0 12px; 
            font-size:16px; 
            line-height:1.5;
            gap: 8px;
        }
        #inputArea { 
            flex-shrink:0; 
            display:flex; 
            flex-wrap: nowrap;
            align-items:center; 
            gap:8px; 
            padding: 18px 20px 18px 16px; 
            padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px)); 
            border-top: 1px solid #e9ecef;
            background: #fff; 
        }
        #msgInput { 
            flex:1; 
            min-width: 0;
            padding:10px 12px; 
            font-size:15px; 
            border-radius:12px; 
            border:1px solid #dee2e6; 
            -webkit-appearance:none; 
        }
        #sendBtn, #shareBtn { 
            padding:12px 14px; 
            font-size:15px; 
            border-radius:12px; 
            white-space:nowrap; 
            cursor:pointer; 
            flex-shrink:0; 
            border: 1px solid #dee2e6;
            background-color: #f7f7f7;
            transition: background-color 0.2s ease;
        }
        #sendBtn { padding: 10px 12px; }
        #sendBtn:hover, #shareBtn:hover { background-color: #e9ecef; }
        .msg { word-break:break-word; }
        .system-msg { word-break:break-word; color: #6c757d; font-style: italic; }
        #charCount { 
            font-size:14px; 
            user-select:none; 
            flex-shrink:0; 
            min-width:45px; 
            text-align:right; 
            color: #6c757d;
        }
        {{.ResponsiveCSS}}
        @media (max-width: 768px) {
            #inputArea { padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)); gap: 4px; }
            #messages { font-size: 18px; line-height: 1.6; }
            #msgInput { font-size: 16px; padding: 10px; }
            #sendBtn, #shareBtn { font-size: 14px; padding: 12px; }
            #charCount { font-size: 11px; min-width: 35px; }
        }
    </style>
</head>
<body>
<div id="header"><button id="shareBtn">Share Invite Link</button></div>
<div id="messages"></div>
<form id="inputForm">
<div id="inputArea"><input id="msgInput" type="text" maxlength="160" placeholder="Say something..." autocomplete="off"><span id="charCount">0/160</span><button id="sendBtn" type="submit">Send</button></div>
</form>
<script>
(() => {
    const roomID = window.location.pathname.substring(1);
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${location.host}/ws?room=${roomID}`;

    const elements = {
        messages: document.getElementById('messages'),
        input:    document.getElementById('msgInput'),
        charCount: document.getElementById('charCount'),
        form:      document.getElementById('inputForm'),
    };

    const MAX_RECONNECT_ATTEMPTS = 5;
    const INITIAL_RECONNECT_DELAY_MS = 2000;
    let reconnectAttempts = 0;
    let reconnectDelay = INITIAL_RECONNECT_DELAY_MS;

    let websocketConn;
    let reconnectTimeout;

    const setAppHeight = () => {
        const doc = document.documentElement;
        let viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        doc.style.setProperty('--app-height', `${viewportHeight}px`);
    };

    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', setAppHeight);
    } else {
        window.addEventListener('resize', setAppHeight);
    }
    window.addEventListener('orientationchange', setAppHeight);
    setAppHeight();

    const connect = () => {
        clearTimeout(reconnectTimeout);
        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            elements.messages.innerHTML += '<div class="system-msg">Connection lost. Please refresh.</div>';
            return;
        }
        websocketConn = new WebSocket(wsUrl);
        websocketConn.onopen = () => {
            reconnectAttempts = 0;
            reconnectDelay = INITIAL_RECONNECT_DELAY_MS;
        };
        websocketConn.onmessage = (event) => {
            const message = event.data;
            const isSystem = message.startsWith("System:");
            const isNameAssignment = isSystem && message.includes("Your name is");
            if (isNameAssignment) { return; }
            const messageEl = document.createElement('div');
            messageEl.className = isSystem ? 'system-msg' : 'msg';
            messageEl.textContent = message;
            
            elements.messages.prepend(messageEl);
            setTimeout(() => {
                elements.messages.scrollTop = 0;
            }, 0);
        };
        websocketConn.onclose = (event) => {
            if (event.code !== 1000) {
                reconnectAttempts++;
                reconnectTimeout = setTimeout(connect, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 30000);
            }
        };
        websocketConn.onerror = () => { websocketConn.close(); };
    };

    const sendMessage = () => {
        const text = elements.input.value.trim();
        if (text && websocketConn.readyState === WebSocket.OPEN) {
            websocketConn.send(text);
            elements.input.value = '';
            updateCharCount();
        }
    };
    
    const shareLink = () => {
        const shareButton = document.getElementById('shareBtn');
        const originalText = shareButton.textContent;
        const textToCopy = location.href;
        const shareData = {
            title: 'Join my Chat Room',
            text: 'Click the link to join my chat room!',
            url: textToCopy
        };
        const resetButtonText = () => { shareButton.textContent = originalText; };
        const copySuccess = () => {
            shareButton.textContent = 'Copied!';
            setTimeout(resetButtonText, 2000);
        };
        if (navigator.share) {
            navigator.share(shareData).catch(() => fallbackCopy(textToCopy, copySuccess));
        } else {
            fallbackCopy(textToCopy, copySuccess);
        }
    };
    
    const fallbackCopy = (text, onSuccess) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) { onSuccess(); } else { console.error('Copy failed'); }
        } catch (err) { console.error('Copy error', err); }
        document.body.removeChild(textArea);
    };

    const updateCharCount = () => {
        const length = elements.input.value.length;
        elements.charCount.textContent = `${length}/160`;
    };

    elements.form.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
    elements.input.addEventListener('input', updateCharCount);
    document.getElementById('shareBtn').addEventListener('click', shareLink);

    elements.input.focus();
    updateCharCount();
    connect();
})();
</script>
</body>
</html>